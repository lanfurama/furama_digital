{% for source, group in reviews.items %}
<div class="mb-10">
  <div class="rounded-2xl shadow-md overflow-hidden border border-gray-100 bg-white">
    <!-- Table Header Card -->
    <div class="px-4 py-2 border-b border-gray-100 bg-white flex flex-col gap-1">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <span class="text-blue-900 text-2xl font-bold uppercase tracking-wide">{{ source }}</span>
        {% if latest_updated_time %}
          <div class="flex flex-col sm:flex-row sm:items-center gap-1">
            {% if compare_date %}
              <span class="bg-neutral-800 text-white text-base font-semibold px-3 py-1 rounded-full ml-2">
                Comparing: <b>{{ compare_date }}</b> â†’ <b>{{ latest_updated_time }}</b>
              </span>
            {% endif %}
            <span class="text-sm">Latest updated: <b>{{ latest_updated_time|date:'Y-m-d' }}</b></span>
          </div>
        {% endif %}
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-base bg-white">
        <thead>
          <tr class="text-blue-800 text-left bg-gradient-to-r from-blue-100 to-green-100 sticky top-0 z-10 border-b-2 border-blue-200 shadow-sm">
            <th class="px-2">Resort</th>
            <th class="px-4 py-3">Rating </th>
            <th class="px-4 py-3">Total Reviews</th>
            {% for key in group.criteria_keys %}
              <th class="px-4 py-3">{{ key|capfirst }}</th>
            {% endfor %}
            <th class="px-4 py-3">URL</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for review in group.reviews %}
          <tr class="hover:bg-yellow-50 transition rounded-xl">
            <!-- Resort with avatar -->
            <td class="px-4 py-2 font-semibold flex items-center gap-3 bg-white">
              <span class="w-8 h-8 bg-gradient-to-r from-blue-100 to-green-100 text-blue-800 rounded-full flex items-center justify-center font-bold text-lg shadow-sm">{{ review.resort|slice:":1" }}</span>
              <span>{{ review.resort }}</span>
            </td>
            <!-- Rating -->
            <td class="px-2 py-2 border font-semibold text-left">
              <div class="flex w-24">
                <div class="w-1/2 flex items-center">
                  <span class="text-[15px] font-semibold {% if review.highest_rating %}text-green-600 font-bold{% elif review.lowest_rating %}text-red-500 font-bold{% endif %} text-gray-800 tracking-wide">{{ review.rating }}</span>
                </div>
                {% if review.increased_rating > 0 %}
                <span class="text-[11px] text-green-800 bg-gradient-to-r from-green-100 via-green-200 to-green-100 px-1.5 py-0.5 rounded ml-1" title="Up">+{{ review.increased_rating }}</span>
                {% elif review.decreased_rating > 0 %}
                <span class="text-[11px] text-red-700 bg-gradient-to-r from-red-100 via-red-200 to-red-100 px-1.5 py-0.5 rounded ml-1" title="Down">-{{ review.decreased_rating }}</span>
                {% endif %}
              </div>
            </td>
            <!-- Total Reviews -->
            <td class="px-2 py-2 border font-semibold text-left bg-white">
              <div class="flex w-28">
                <div class="w-1/2 flex items-center">
                  <span class="text-[15px] font-semibold {% if review.highest_total_reviews %}text-green-600 font-bold{% elif review.lowest_total_reviews %}text-red-500 font-bold{% endif %} text-gray-800 tracking-wide">{{ review.total_reviews }}</span>
                </div>
                {% if review.increased_total_reviews > 0 %}
                <span class="text-[11px] text-green-800 bg-gradient-to-r from-green-100 via-green-200 to-green-100 px-1.5 py-0.5 rounded ml-1" title="Up">+{{ review.increased_total_reviews }}</span>
                {% elif review.decreased_total_reviews > 0 %}
                <span class="text-[11px] text-red-700 bg-gradient-to-r from-red-100 via-red-200 to-red-100 px-1.5 py-0.5 rounded ml-1" title="Down">-{{ review.decreased_total_reviews }}</span>
                {% endif %}
              </div>
            </td>
            <!-- Scores by key -->
            {% load custom_filters %}
            {% for key in group.criteria_keys %}
              {% with review.scores_dict|get_item:key as matched_score %}
              <td class="px-2 py-2 font-semibold border
                {% if matched_score and matched_score.highest_score %}text-green-600 font-bold{% endif %}
                {% if matched_score and matched_score.lowest_score %}text-red-600 font-bold{% endif %}
                bg-white">
                {% if matched_score %}
                  <div class="flex w-24">
                    <div class="w-1/2 flex items-center">
                      <span class="text-[15px] font-semibold text-gray-800 
                      {% if matched_score and matched_score.highest_score %}text-green-600 font-bold{% endif %}
                      {% if matched_score and matched_score.lowest_score %}text-red-600 font-bold{% endif %}
                      tracking-wide">{{ matched_score.value }}</span>
                    </div>
                    <div class="w-1/2 flex justify-end items-center">
                      {% if matched_score.increased_value > 0 %}
                        <span class="text-[11px] text-green-800 bg-gradient-to-r from-green-100 via-green-200 to-green-100 px-1.5 py-0.5 rounded ml-1" title="Up">+{{ matched_score.increased_value }}</span>
                      {% elif matched_score.decreased_value > 0 %}
                        <span class="text-[11px] text-red-700 bg-gradient-to-r from-red-100 via-red-200 to-red-100 px-1.5 py-0.5 rounded ml-1" title="Down">-{{ matched_score.decreased_value }}</span>
                      {% endif %}
                    </div>
                  </div>
                {% else %}
                  <span class="text-gray-400 italic">N/A</span>
                {% endif %}
              </td>
              {% endwith %}
            {% endfor %}
            <!-- URL -->
            <td class="px-2 py-2 border text-blue-600 underline font-semibold hover:text-black transition bg-white">
              <a href="{{ review.url }}" target="_blank">Link</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endfor %}
